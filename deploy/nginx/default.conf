server {
    # 1) HTTP 80 포트에서 수신 (TLS는 상단에서 80->443 리다이렉트용 블록 추가 가능)
    listen 80;

    # 2) 배포 시 실제 도메인으로 교체하세요. 여러 도메인을 지원하려면 공백으로 구분
    #    예) server_name example.com www.example.com;
    #    임시로 모든 Host 헤더를 허용하려면 _ 를 유지합니다.
    server_name _;

    # 3) 커널의 sendfile(제로-카피) 사용: 정적 파일 전송 성능 향상
    sendfile on;
    # 4) 패킷을 크게 모아서 보냄(TCP 성능 최적화)
    tcp_nopush on;
    # 5) Nagle 알고리즘 비활성화(지연 줄이기) - 상황에 따라 on/off
    tcp_nodelay on;

    # 6) MIME 타입 해시 테이블 크기(대규모 타입 정의 시 튜닝)
    types_hash_max_size 2048;

    # 7) 업로드 등 요청 바디 최대 크기 (429/413 예방)
    client_max_body_size 10m;

    # =========================
    # 백엔드 API 프록시 (/api/)
    # =========================
    location /api/ {
        # ※ 슬래시가 있는 proxy_pass는 location 접두사(/api/)를 제거하고 전달.
        # 예) 클라이언트:  /api/users/42
        #     업스트림:    /users/42   (접두사 /api/가 떨어짐)
        proxy_pass http://api:8000/;

        # 원본 Host/Client IP/프로토콜을 백엔드에 전달
        proxy_set_header Host $host;                       # ex) example.com
        proxy_set_header X-Real-IP $remote_addr;          # 실제 클라이언트 IP
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # 프록시 체인
        proxy_set_header X-Forwarded-Proto $scheme;       # http 또는 https

        # 업스트림이 리다이렉트 Location 헤더를 보낼 때, 경로를 건드리지 않음
        proxy_redirect off;

    }

    # =========================
    # 인증 콜백 등 Django에 직접 전달 (/auth/)
    # =========================
    location /auth/ {
        # Google OAuth 콜백(/auth/google/callback 등)이 프론트엔드에서 404가 나지 않고
        # Django 백엔드로 도달하도록 API 컨테이너로 프록시합니다.
        proxy_pass http://api:8000;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_redirect off;
    }

    # =========================
    # 정적 파일 직접 서빙 (/static/)
    # =========================
    location /static/ {
        # alias는 요청 경로의 접두사(/static/)를 실제 디렉토리로 치환
        # ex) /static/app.css -> /var/www/static/app.css
        alias /var/www/static/;

        # 정적 파일은 접근 로그 생략하여 디스크 I/O 절약
        access_log off;

        # 브라우저 캐시 30일
        expires 30d;
        # 캐시 정책 헤더 추가
        add_header Cache-Control "public";
        # (선택) 해시된 파일이면 immutable까지
        # add_header Cache-Control "public, max-age=2592000, immutable";
    }

    # =========================
    # 프론트엔드(HMR 지원 dev 서버) 프록시 (그 외 모든 경로)
    # dev/oidc 등 HTTP 개발 스택에서 사용
    # =========================
    location / {
        # ※ 여기서는 뒤에 슬래시가 없는 proxy_pass
        #     예) /dashboard -> 업스트림에도 /dashboard로 그대로 전달
        proxy_pass http://web:3000;

        # HTTP/1.1로 업그레이드(웹소켓/HMR 등에 필요)
        proxy_http_version 1.1;
        proxy_set_header Host $host;

        # 웹소켓 업그레이드(Vite dev/HMR, 일부 앱의 실시간 기능)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # 원본 클라이언트 정보 전달
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # (선택) 정적 사이트 프리렌더링 시 캐싱 정책이나 gzip 등을 추가 구성

        # (선택) SPA 라우팅을 Nginx에서 처리하려면 try_files 고려
        # try_files $uri $uri/ /index.html;

            # =========================
    # Airflow UI / API 프록시
    # 예: /airflow/ 아래로 붙여서 사용
    # =========================
    location /airflow/ {
        # ※ 뒤에 슬래시가 있는 proxy_pass → /airflow/ prefix 제거 후 전달
        #   예) 클라이언트: /airflow/api/v1/dags
        #       업스트림:  /api/v1/dags
        proxy_pass http://airflow-webserver:8080/;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_redirect off;
    }

    }
}
