# =========================
# WebSocket 업그레이드용 (keep)
# =========================
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

# =========================
# Upstreams (가독성 + keepalive)
# =========================
upstream web_upstream {
  server web:3000;
  keepalive 32;
}

upstream api_upstream {
  server api:8000;
  keepalive 32;
}

upstream airflow_upstream {
  server airflow-webserver:8080;
  keepalive 16;
}

# =========================
# 1) HTTP -> HTTPS 리다이렉트
# =========================
server {
  listen 80;
  server_name stg.plane.samsungds.net;
  return 301 https://$host$request_uri;
}

# =========================
# 2) HTTPS 서버
# =========================
server {
  listen 443 ssl http2;
  server_name stg.plane.samsungds.net;

  # TLS 인증서 경로 (/etc/nginx/certs 로 호스트 마운트 필요)
  ssl_certificate     /etc/nginx/certs/fullchain.crt;
  ssl_certificate_key /etc/nginx/certs/server.key;

  # Modern TLS 기본값
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_prefer_server_ciphers off;
  ssl_session_cache   shared:SSL:10m;
  ssl_session_timeout 1d;

  # HSTS(선택) - 운영 정책에 맞을 때만 includeSubDomains 유지
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

  # 공통 성능/제한
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  types_hash_max_size 2048;

  # 업로드 여유 (Django 업로드/첨부 대비)
  client_max_body_size 50m;

  # =========================
  # 공통 프록시 기본값 (location에서 상속될 수 있으나,
  # Vite Host 차단 이슈 방지를 위해 각 location에 핵심 헤더를 "명시"함)
  # =========================
  proxy_http_version 1.1;
  proxy_redirect off;
  proxy_read_timeout 3600s;
  proxy_send_timeout 3600s;

  # =========================
  # (B) 정적 파일 직접 서빙 (/static/)
  # =========================
  location /static/ {
    alias /var/www/static/;
    access_log off;
    expires 30d;
    add_header Cache-Control "public";
    # add_header Cache-Control "public, max-age=2592000, immutable";
  }

  # =========================
  # (A) Django 백엔드 프록시
  # =========================

  # (A) API 프록시 (/api/) - /api 접두사 유지
  location /api/ {
    proxy_pass http://api_upstream;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # (A-1) 인증/콜백 URL 프록시 (/auth/)
  location /auth/ {
    proxy_pass http://api_upstream;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # (A-3) Django Admin 프록시 (/admin/)
  location /admin/ {
    proxy_pass http://api_upstream;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # =========================
  # (A-2) Airflow UI 프록시 (/airflow/)
  # =========================
  location /airflow/ {
    proxy_pass http://airflow_upstream;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket/스트리밍 대응
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    # (선택) 스트리밍/로그 tail에서 버퍼링 이슈 있으면
    # proxy_buffering off;
  }

  # =========================
  # (C) 프론트엔드(SPA) 프록시 (그 외 모든 경로)
  # - ✅ 핵심: 여기서 Host를 반드시 $host로 "명시"해야
  #   Vite가 web_upstream Host로 차단하는 문제가 사라짐
  # =========================
  location / {
    proxy_pass http://web_upstream;

    # ✅ Vite allowedHosts 차단 방지 (필수)
    proxy_set_header Host $host;

    # WebSocket/HMR 업그레이드
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    # 원본 클라이언트 정보 전달
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # (선택) dev 서버 캐싱 방지 원하면
    # add_header Cache-Control "no-store";
  }
}

