{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///home/pjw75/tailwind/src/lib/db.js"],"sourcesContent":["// src/lib/db.js\nimport mysql from \"mysql2/promise\"\n\nlet pool = null\n\nfunction getConfig() {\n  const host = process.env.DB_HOST ?? \"127.0.0.1\"\n  const port = Number.parseInt(process.env.DB_PORT ?? \"3307\", 10)\n  const user = process.env.DB_USER ?? \"drone_user\"\n  const password = process.env.DB_PASSWORD ?? \"dronepwd\"\n  const database = process.env.DB_NAME ?? \"drone_sop\"\n\n  return {\n    host,\n    port: Number.isNaN(port) ? 3307 : port,\n    user,\n    password,\n    database,\n  }\n}\n\nexport function getPool() {\n  if (!pool) {\n    const config = getConfig()\n    pool = mysql.createPool({\n      ...config,\n      waitForConnections: true,\n      connectionLimit: 10,\n      // âœ… í•œêµ­ì‹œê°„ (UTC+9)\n      timezone: \"+09:00\",\n    })\n  }\n  return pool\n}\n\nexport async function runQuery(sql, params = []) {\n  const currentPool = getPool()\n  const [rows] = await currentPool.query(sql, params)\n  return rows\n}\n"],"names":[],"mappings":"AAAA,gBAAgB;;;;;;;AAChB;;AAEA,IAAI,OAAO;AAEX,SAAS;IACP,MAAM,OAAO,QAAQ,GAAG,CAAC,OAAO,IAAI;IACpC,MAAM,OAAO,OAAO,QAAQ,CAAC,QAAQ,GAAG,CAAC,OAAO,IAAI,QAAQ;IAC5D,MAAM,OAAO,QAAQ,GAAG,CAAC,OAAO,IAAI;IACpC,MAAM,WAAW,QAAQ,GAAG,CAAC,WAAW,IAAI;IAC5C,MAAM,WAAW,QAAQ,GAAG,CAAC,OAAO,IAAI;IAExC,OAAO;QACL;QACA,MAAM,OAAO,KAAK,CAAC,QAAQ,OAAO;QAClC;QACA;QACA;IACF;AACF;AAEO,SAAS;IACd,IAAI,CAAC,MAAM;QACT,MAAM,SAAS;QACf,OAAO,8MAAK,CAAC,UAAU,CAAC;YACtB,GAAG,MAAM;YACT,oBAAoB;YACpB,iBAAiB;YACjB,iBAAiB;YACjB,UAAU;QACZ;IACF;IACA,OAAO;AACT;AAEO,eAAe,SAAS,GAAG,EAAE,SAAS,EAAE;IAC7C,MAAM,cAAc;IACpB,MAAM,CAAC,KAAK,GAAG,MAAM,YAAY,KAAK,CAAC,KAAK;IAC5C,OAAO;AACT","debugId":null}},
    {"offset": {"line": 164, "column": 0}, "map": {"version":3,"sources":["file:///home/pjw75/tailwind/src/features/line-dashboard/components/data-table/utils/constants.js"],"sourcesContent":["// src/features/line-dashboard/components/data-table/utils/constants.js\n// ë°ì´í„° í…Œì´ë¸” ì „ì—­ì—ì„œ ì¬ì‚¬ìš©í•˜ëŠ” ìƒìˆ˜ì™€ í¬ë§·í„°ë“¤ì…ë‹ˆë‹¤.\nexport const DEFAULT_TABLE = \"drone_sop_v3\"\nexport const DEFAULT_RANGE_DAYS = 3\n\nconst DAY_IN_MS = 86_400_000\n\n// Date ê°ì²´ë¥¼ YYYY-MM-DD ë¬¸ìì—´ë¡œ ë°”ê¿” í¼ ì…ë ¥ê³¼ í˜¸í™˜ë˜ê²Œ ë§Œë“­ë‹ˆë‹¤.\nexport const toDateInputValue = (date) => date.toISOString().split(\"T\")[0]\n\nexport const getDefaultFromValue = () => {\n  const now = new Date()\n  const from = new Date(now.getTime() - DEFAULT_RANGE_DAYS * DAY_IN_MS)\n  return toDateInputValue(from)\n}\n\nexport const getDefaultToValue = () => toDateInputValue(new Date())\n\n// ì…€ ì €ì¥ ì¸ë””ì¼€ì´í„° ë…¸ì¶œ ì‹œê°„ì„ ì œì–´í•˜ëŠ” ê°’ë“¤ì…ë‹ˆë‹¤.\nexport const SAVING_DELAY_MS = 180\nexport const MIN_SAVING_VISIBLE_MS = 500\nexport const SAVED_VISIBLE_MS = 800\n\n// í”„ë¡œì„¸ìŠ¤ í”Œë¡œìš°ì™€ ê´€ë ¨ëœ ì»¬ëŸ¼ í‚¤ ëª©ë¡ì…ë‹ˆë‹¤.\nexport const STEP_COLUMN_KEYS = [\n  \"main_step\",\n  \"metro_steps\",\n  \"metro_current_step\",\n  \"metro_end_step\",\n  \"custom_end_step\",\n  \"inform_step\",\n]\n\nexport const STEP_COLUMN_KEY_SET = new Set(STEP_COLUMN_KEYS)\n\n// UI í‘œì‹œì— ì‚¬ìš©í•  ê³µí†µ ìˆ«ì/ì‹œê°„ í¬ë§·í„°ì…ë‹ˆë‹¤.\nexport const numberFormatter = new Intl.NumberFormat(\"en-US\")\nexport const timeFormatter = new Intl.DateTimeFormat(\"en-US\", {\n  hour: \"2-digit\",\n  minute: \"2-digit\",\n  second: \"2-digit\",\n})\n"],"names":[],"mappings":"AAAA,uEAAuE;AACvE,kCAAkC;;;;;;;;;;;;;;;;;;;;;;;;;;;AAC3B,MAAM,gBAAgB;AACtB,MAAM,qBAAqB;AAElC,MAAM,YAAY;AAGX,MAAM,mBAAmB,CAAC,OAAS,KAAK,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;AAEnE,MAAM,sBAAsB;IACjC,MAAM,MAAM,IAAI;IAChB,MAAM,OAAO,IAAI,KAAK,IAAI,OAAO,KAAK,qBAAqB;IAC3D,OAAO,iBAAiB;AAC1B;AAEO,MAAM,oBAAoB,IAAM,iBAAiB,IAAI;AAGrD,MAAM,kBAAkB;AACxB,MAAM,wBAAwB;AAC9B,MAAM,mBAAmB;AAGzB,MAAM,mBAAmB;IAC9B;IACA;IACA;IACA;IACA;IACA;CACD;AAEM,MAAM,sBAAsB,IAAI,IAAI;AAGpC,MAAM,kBAAkB,IAAI,KAAK,YAAY,CAAC;AAC9C,MAAM,gBAAgB,IAAI,KAAK,cAAc,CAAC,SAAS;IAC5D,MAAM;IACN,QAAQ;IACR,QAAQ;AACV","debugId":null}},
    {"offset": {"line": 224, "column": 0}, "map": {"version":3,"sources":["file:///home/pjw75/tailwind/src/features/line-dashboard/api/constants.js"],"sourcesContent":["// src/features/line-dashboard/api/constants.js\n// API ìœ í‹¸ ì „ë°˜ì—ì„œ ê³µìœ í•˜ëŠ” ì •ê·œì‹/ìƒìˆ˜ ëª¨ìŒì…ë‹ˆë‹¤.\nexport const SAFE_IDENTIFIER = /^[A-Za-z0-9_]+$/\n\n// YYYY-MM-DD í¬ë§· ê²€ì‚¬ì— ì‚¬ìš©ë©ë‹ˆë‹¤.\nexport const DATE_ONLY_REGEX = /^\\d{4}-\\d{2}-\\d{2}$/\n\n// íƒ€ì„ìŠ¤íƒ¬í”„ í›„ë³´ ì»¬ëŸ¼ ì´ë¦„ ëª©ë¡(ìš°ì„ ìˆœìœ„ ìˆœ).\nexport const DATE_COLUMN_CANDIDATES = [\"created_at\", \"updated_at\", \"timestamp\", \"ts\", \"date\"]\n\n// ë¼ì¸ ìš”ì•½ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ê¸°ë³¸ í…Œì´ë¸” ì´ë¦„ì…ë‹ˆë‹¤.\nexport const LINE_SDWT_TABLE_NAME = \"line_sdwt\"\n"],"names":[],"mappings":"AAAA,+CAA+C;AAC/C,iCAAiC;;;;;;;;;;;AAC1B,MAAM,kBAAkB;AAGxB,MAAM,kBAAkB;AAGxB,MAAM,yBAAyB;IAAC;IAAc;IAAc;IAAa;IAAM;CAAO;AAGtF,MAAM,uBAAuB","debugId":null}},
    {"offset": {"line": 250, "column": 0}, "map": {"version":3,"sources":["file:///home/pjw75/tailwind/src/features/line-dashboard/api/columns.js"],"sourcesContent":["// src/features/line-dashboard/api/columns.js\n\nimport { DATE_COLUMN_CANDIDATES } from \"./constants\"\n\n/* ============================================================================\n * âœ… findColumn(columnNames, target)\n * ----------------------------------------------------------------------------\n * - ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë°›ì€ ì»¬ëŸ¼ ì´ë¦„ ë°°ì—´(columnNames) ì¤‘ì—ì„œ\n *   íŠ¹ì • ì´ë¦„(target)ê³¼ \"ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´\" ì¼ì¹˜í•˜ëŠ” í•­ëª©ì„ ì°¾ì•„ì¤ë‹ˆë‹¤.\n *\n * ì˜ˆì‹œ)\n *   findColumn([\"ID\", \"Created_At\", \"Name\"], \"created_at\")\n *   â†’ \"Created_At\" (ëŒ€ì†Œë¬¸ì ë‹¬ë¼ë„ OK)\n * ============================================================================\n */\nexport function findColumn(columnNames, target) {\n  // ì•ˆì „í•˜ê²Œ ë°°ì—´ í˜•íƒœë¡œ ê°•ì œ ë³€í™˜ (null, undefined ë°©ì§€)\n  const list = Array.isArray(columnNames) ? columnNames : []\n\n  // ì°¾ê³  ì‹¶ì€ ëŒ€ìƒ ë¬¸ìì—´ì„ ì†Œë¬¸ìë¡œ í†µì¼\n  const targetLower = String(target ?? \"\").toLowerCase()\n\n  // ëª¨ë“  ì»¬ëŸ¼ ì´ë¦„ì„ ìˆœíšŒí•˜ë©° ë¹„êµ\n  for (const name of list) {\n    if (typeof name !== \"string\") continue // ë¬¸ìì—´ì´ ì•„ë‹Œ ê°’ì€ ë¬´ì‹œ\n    if (name.toLowerCase() === targetLower) return name // ì¼ì¹˜í•˜ë©´ ì›ë˜ ì´ë¦„ ê·¸ëŒ€ë¡œ ë°˜í™˜\n  }\n\n  // ëê¹Œì§€ ëª» ì°¾ìœ¼ë©´ null\n  return null\n}\n\n/* ============================================================================\n * âœ… pickBaseTimestampColumn(columnNames)\n * ----------------------------------------------------------------------------\n * - DATE_COLUMN_CANDIDATESì— ì •ì˜ëœ \"ë‚ ì§œ/ì‹œê°„ ê´€ë ¨ ì»¬ëŸ¼ ì´ë¦„ í›„ë³´ë“¤\" ì¤‘ì—ì„œ\n *   ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ì²« ë²ˆì§¸ ì»¬ëŸ¼ ì´ë¦„ì„ ì°¾ì•„ ë°˜í™˜í•©ë‹ˆë‹¤.\n *\n * ì˜ˆì‹œ)\n *   DATE_COLUMN_CANDIDATES = [\"updated_at\", \"created_at\", \"timestamp\", \"date\"]\n *   columnNames = [\"id\", \"timestamp\"]\n *   â†’ \"timestamp\" ë°˜í™˜\n *\n * - ì—†ìœ¼ë©´ null ë°˜í™˜\n * ============================================================================\n */\nexport function pickBaseTimestampColumn(columnNames) {\n  // í›„ë³´ ëª©ë¡ì„ ìˆœì„œëŒ€ë¡œ í™•ì¸\n  for (const candidate of DATE_COLUMN_CANDIDATES) {\n    const found = findColumn(columnNames, candidate)\n    if (found) return found // ì²« ë²ˆì§¸ë¡œ ë°œê²¬ëœ ì»¬ëŸ¼ ë°˜í™˜\n  }\n\n  // í›„ë³´ ì¤‘ ì•„ë¬´ ê²ƒë„ ì—†ìœ¼ë©´ null\n  return null\n}\n"],"names":[],"mappings":"AAAA,6CAA6C;;;;;;;AAE7C;;AAaO,SAAS,WAAW,WAAW,EAAE,MAAM;IAC5C,yCAAyC;IACzC,MAAM,OAAO,MAAM,OAAO,CAAC,eAAe,cAAc,EAAE;IAE1D,wBAAwB;IACxB,MAAM,cAAc,OAAO,UAAU,IAAI,WAAW;IAEpD,oBAAoB;IACpB,KAAK,MAAM,QAAQ,KAAM;QACvB,IAAI,OAAO,SAAS,UAAU,UAAS,gBAAgB;QACvD,IAAI,KAAK,WAAW,OAAO,aAAa,OAAO,KAAK,oBAAoB;;IAC1E;IAEA,iBAAiB;IACjB,OAAO;AACT;AAgBO,SAAS,wBAAwB,WAAW;IACjD,iBAAiB;IACjB,KAAK,MAAM,aAAa,gMAAsB,CAAE;QAC9C,MAAM,QAAQ,WAAW,aAAa;QACtC,IAAI,OAAO,OAAO,MAAM,kBAAkB;;IAC5C;IAEA,sBAAsB;IACtB,OAAO;AACT","debugId":null}},
    {"offset": {"line": 287, "column": 0}, "map": {"version":3,"sources":["file:///home/pjw75/tailwind/src/features/line-dashboard/api/validation.js"],"sourcesContent":["// src/features/line-dashboard/api/validation.js\nimport { DATE_ONLY_REGEX, SAFE_IDENTIFIER } from \"./constants\"\n\n/* ============================================================================\n * ğŸ§© validation.js â€” ì…ë ¥ê°’ ê²€ì¦ ê´€ë ¨ ìœ í‹¸ í•¨ìˆ˜ ëª¨ìŒ\n * ----------------------------------------------------------------------------\n * âœ… ì£¼ìš” ëª©ì \n * - SQL ì¸ì ì…˜ ë°©ì§€: í…Œì´ë¸”/ì»¬ëŸ¼ ì´ë¦„ì— ìœ„í—˜í•œ ë¬¸ìê°€ ë“¤ì–´ì˜¤ëŠ” ê²ƒì„ ì°¨ë‹¨\n * - ë‚ ì§œ ë¬¸ìì—´ ê²€ì¦: YYYY-MM-DD í˜•ì‹ì´ ë§ëŠ”ì§€ í™•ì¸\n * ========================================================================== */\n\n/**\n * ë¬¸ìì—´ì„ SQLìš© ì•ˆì „í•œ ì‹ë³„ì(identifier)ë¡œ ì •ë¦¬í•©ë‹ˆë‹¤.\n * - ì£¼ë¡œ í…Œì´ë¸”ëª…, ì»¬ëŸ¼ëª… ë“± SQL ì¿¼ë¦¬ ë‚´ì—ì„œ ì§ì ‘ ë¬¸ìì—´ë¡œ ë“¤ì–´ê°€ëŠ” í•­ëª©ì— ì‚¬ìš©\n * - ì˜ë¬¸, ìˆ«ì, ë°‘ì¤„(_)ë§Œ í—ˆìš©í•©ë‹ˆë‹¤.\n * - ì¡°ê±´ì— ë§ì§€ ì•Šìœ¼ë©´ fallback(ê¸°ë³¸ê°’)ì„ ë°˜í™˜í•©ë‹ˆë‹¤.\n *\n * ì˜ˆì‹œ:\n *   sanitizeIdentifier(\"line_sdwt\") â†’ \"line_sdwt\"\n *   sanitizeIdentifier(\"DROP TABLE users;\") â†’ null (ì•ˆì „í•˜ê²Œ ì°¨ë‹¨)\n */\nexport function sanitizeIdentifier(value, fallback = null) {\n  if (typeof value !== \"string\") return fallback\n\n  const trimmed = value.trim()\n  return SAFE_IDENTIFIER.test(trimmed) ? trimmed : fallback\n}\n\n/**\n * ë‚ ì§œ ë¬¸ìì—´ì„ ê²€ì¦í•©ë‹ˆë‹¤ (í˜•ì‹: YYYY-MM-DD)\n * - ì˜¬ë°”ë¥¸ í˜•ì‹ì¼ ê²½ìš° ê·¸ëŒ€ë¡œ ë°˜í™˜\n * - ì˜ëª»ëœ í˜•ì‹(ì˜ˆ: \"2025/01/01\" ë˜ëŠ” \"25-01-01\")ì´ë©´ null ë°˜í™˜\n *\n * ì˜ˆì‹œ:\n *   normalizeDateOnly(\"2025-11-04\") â†’ \"2025-11-04\"\n *   normalizeDateOnly(\"2025/11/04\") â†’ null\n */\nexport function normalizeDateOnly(value) {\n  if (typeof value !== \"string\") return null\n\n  const trimmed = value.trim()\n  return DATE_ONLY_REGEX.test(trimmed) ? trimmed : null\n}\n"],"names":[],"mappings":"AAAA,gDAAgD;;;;;;;AAChD;;AAoBO,SAAS,mBAAmB,KAAK,EAAE,WAAW,IAAI;IACvD,IAAI,OAAO,UAAU,UAAU,OAAO;IAEtC,MAAM,UAAU,MAAM,IAAI;IAC1B,OAAO,yLAAe,CAAC,IAAI,CAAC,WAAW,UAAU;AACnD;AAWO,SAAS,kBAAkB,KAAK;IACrC,IAAI,OAAO,UAAU,UAAU,OAAO;IAEtC,MAAM,UAAU,MAAM,IAAI;IAC1B,OAAO,yLAAe,CAAC,IAAI,CAAC,WAAW,UAAU;AACnD","debugId":null}},
    {"offset": {"line": 310, "column": 0}, "map": {"version":3,"sources":["file:///home/pjw75/tailwind/src/features/line-dashboard/api/lineFilters.js"],"sourcesContent":["// src/features/line-dashboard/api/lineFilters.js\nimport { runQuery } from \"@/lib/db\"\nimport { LINE_SDWT_TABLE_NAME } from \"./constants\"\nimport { findColumn } from \"./columns\"\n\nconst USER_SDWT_PROD_LOOKUP_QUERY = `\n  SELECT DISTINCT user_sdwt_prod\n  FROM \\`${LINE_SDWT_TABLE_NAME}\\`\n  WHERE line_id = ?\n    AND user_sdwt_prod IS NOT NULL\n    AND user_sdwt_prod <> ''\n`\n\n/**\n * íŠ¹ì • line_idì— ì—°ê²°ëœ user_sdwt_prod ëª©ë¡ ì¡°íšŒ\n * - ë¬¸ìì—´ë§Œ ì¶”ë ¤ì„œ trim í›„ ì¤‘ë³µ ì œê±°(Set)\n */\nasync function getUserSdwtProdValues(lineId) {\n  const rows = await runQuery(USER_SDWT_PROD_LOOKUP_QUERY, [lineId])\n  const set = new Set()\n  for (const r of rows || []) {\n    const v = typeof r?.user_sdwt_prod === \"string\" ? r.user_sdwt_prod.trim() : \"\"\n    if (v) set.add(v)\n  }\n  return Array.from(set)\n}\n\n/**\n * ë¼ì¸ í•„í„° WHERE/params ìƒì„± (ê°„ê²° ë²„ì „)\n * ------------------------------------------------------------\n * 1) user_sdwt_prod ì»¬ëŸ¼ì´ ì¡´ì¬í•˜ê³ , í•´ë‹¹ lineì— ë§¤í•‘ê°’ì´ ìˆìœ¼ë©´:\n *    - `user_sdwt_prod IN (?, ?, â€¦)` ë¡œ í•„í„°\n * 2) ê·¸ë ‡ì§€ ì•Šìœ¼ë©´(ì»¬ëŸ¼ì´ ì—†ê±°ë‚˜ ë§¤í•‘ì´ ë¹„ì—ˆìœ¼ë©´):\n *    - line_id ì»¬ëŸ¼ì´ ìˆëŠ” ê²½ìš° `line_id = ?` ë¡œ í•„í„°\n * 3) line_idë„ ì—†ìœ¼ë©´ í•„í„° ì—†ì´ ë°˜í™˜\n *\n * @param {string[]} columnNames - ì‹¤ì œ í…Œì´ë¸” ì»¬ëŸ¼ ì´ë¦„ë“¤\n * @param {string} lineId        - ì™¸ë¶€ì—ì„œ ì´ë¯¸ ì •ê·œí™”(normalize)ëœ line_id\n * @returns {{ filters: string[], params: any[] }}\n *   - filters: WHERE ì ˆ ì¡°ê° ë°°ì—´ (ì˜ˆ: [\"`line_id` = ?\", \"`user_sdwt_prod` IN (?, ?)\"])\n *   - params : ë°”ì¸ë”© ê°’ ë°°ì—´\n */\nexport async function buildLineFilters(columnNames, lineId) {\n  const filters = []\n  const params = []\n\n  // lineIdê°€ ì—†ìœ¼ë©´ í•„í„° ì—†ì´ ì¢…ë£Œ\n  if (!lineId) return { filters, params }\n\n  // 1) user_sdwt_prod ìš°ì„  ì‚¬ìš©\n  const usdwtCol = findColumn(columnNames, \"user_sdwt_prod\")\n  if (usdwtCol) {\n    const values = await getUserSdwtProdValues(lineId)\n    if (values.length > 0) {\n      const placeholders = values.map(() => \"?\").join(\", \")\n      filters.push(`\\`${usdwtCol}\\` IN (${placeholders})`)\n      params.push(...values)\n      return { filters, params }\n    }\n  }\n\n  // 2) í´ë°±: line_id = ?\n  const lineCol = findColumn(columnNames, \"line_id\")\n  if (lineCol) {\n    filters.push(`\\`${lineCol}\\` = ?`)\n    params.push(lineId)\n  }\n\n  return { filters, params }\n}\n"],"names":[],"mappings":"AAAA,iDAAiD;;;;;AACjD;AACA;AACA;;;;AAEA,MAAM,8BAA8B,CAAC;;SAE5B,EAAE,8LAAoB,CAAC;;;;AAIhC,CAAC;AAED;;;CAGC,GACD,eAAe,sBAAsB,MAAM;IACzC,MAAM,OAAO,MAAM,IAAA,0IAAQ,EAAC,6BAA6B;QAAC;KAAO;IACjE,MAAM,MAAM,IAAI;IAChB,KAAK,MAAM,KAAK,QAAQ,EAAE,CAAE;QAC1B,MAAM,IAAI,OAAO,GAAG,mBAAmB,WAAW,EAAE,cAAc,CAAC,IAAI,KAAK;QAC5E,IAAI,GAAG,IAAI,GAAG,CAAC;IACjB;IACA,OAAO,MAAM,IAAI,CAAC;AACpB;AAiBO,eAAe,iBAAiB,WAAW,EAAE,MAAM;IACxD,MAAM,UAAU,EAAE;IAClB,MAAM,SAAS,EAAE;IAEjB,uBAAuB;IACvB,IAAI,CAAC,QAAQ,OAAO;QAAE;QAAS;IAAO;IAEtC,0BAA0B;IAC1B,MAAM,WAAW,IAAA,kLAAU,EAAC,aAAa;IACzC,IAAI,UAAU;QACZ,MAAM,SAAS,MAAM,sBAAsB;QAC3C,IAAI,OAAO,MAAM,GAAG,GAAG;YACrB,MAAM,eAAe,OAAO,GAAG,CAAC,IAAM,KAAK,IAAI,CAAC;YAChD,QAAQ,IAAI,CAAC,CAAC,EAAE,EAAE,SAAS,OAAO,EAAE,aAAa,CAAC,CAAC;YACnD,OAAO,IAAI,IAAI;YACf,OAAO;gBAAE;gBAAS;YAAO;QAC3B;IACF;IAEA,qBAAqB;IACrB,MAAM,UAAU,IAAA,kLAAU,EAAC,aAAa;IACxC,IAAI,SAAS;QACX,QAAQ,IAAI,CAAC,CAAC,EAAE,EAAE,QAAQ,MAAM,CAAC;QACjC,OAAO,IAAI,CAAC;IACd;IAEA,OAAO;QAAE;QAAS;IAAO;AAC3B","debugId":null}},
    {"offset": {"line": 379, "column": 0}, "map": {"version":3,"sources":["file:///home/pjw75/tailwind/src/app/api/tables/route.js"],"sourcesContent":["// src/app/api/tables/route.js\nimport { NextResponse } from \"next/server\"\nimport { runQuery } from \"@/lib/db\"\nimport { DEFAULT_TABLE } from \"@/features/line-dashboard/components/data-table/utils/constants\"\nimport {\n  DATE_COLUMN_CANDIDATES,\n} from \"@/features/line-dashboard/api/constants\"\nimport {\n  pickBaseTimestampColumn,\n} from \"@/features/line-dashboard/api/columns\"\nimport {\n  normalizeDateOnly,\n  sanitizeIdentifier,\n} from \"@/features/line-dashboard/api/validation\"\nimport { buildLineFilters } from \"@/features/line-dashboard/api/lineFilters\"\n\n/**\n * GET /api/tables\n * ----------------\n * Provides a single entry point for fetching table data with consistent date\n * filtering semantics. The heavy lifting is delegated to small focused helper\n * modules so this handler can read like a high level recipe:\n *\n *  1. Validate incoming query parameters\n *  2. Inspect the table schema for a usable timestamp column\n *  3. Build WHERE clauses for the requested line and time range\n *  4. Execute the query and respond with JSON\n */\nexport async function GET(request) {\n  const url = new URL(request.url)\n  const searchParams = url.searchParams\n\n  const tableParam = searchParams.get(\"table\")\n  const fromParam = searchParams.get(\"from\")\n  const toParam = searchParams.get(\"to\")\n  const lineIdParam = searchParams.get(\"lineId\")\n\n  const tableName = sanitizeIdentifier(tableParam, DEFAULT_TABLE)\n  if (!tableName) {\n    return NextResponse.json({ error: \"Invalid table name\" }, { status: 400 })\n  }\n\n  let normalizedFrom = normalizeDateOnly(fromParam)\n  let normalizedTo = normalizeDateOnly(toParam)\n\n  if (normalizedFrom && normalizedTo) {\n    const fromMs = Date.parse(`${normalizedFrom}T00:00:00Z`)\n    const toMs = Date.parse(`${normalizedTo}T23:59:59Z`)\n    if (Number.isFinite(fromMs) && Number.isFinite(toMs) && fromMs > toMs) {\n      ;[normalizedFrom, normalizedTo] = [normalizedTo, normalizedFrom]\n    }\n  }\n\n  const normalizedLineId =\n    typeof lineIdParam === \"string\" && lineIdParam.trim().length > 0\n      ? lineIdParam.trim()\n      : null\n\n  try {\n    const columnRows = await runQuery(`SHOW COLUMNS FROM \\`${tableName}\\``)\n    const columnNames = columnRows\n      .map((column) => column?.Field)\n      .filter((name) => typeof name === \"string\")\n\n    if (columnNames.length === 0) {\n      return NextResponse.json({ error: `Table \"${tableName}\" has no columns` }, { status: 400 })\n    }\n\n    const baseTsCol = pickBaseTimestampColumn(columnNames)\n    if (!baseTsCol) {\n      return NextResponse.json(\n        {\n          error:\n            `No timestamp-like column found in \"${tableName}\". ` +\n            `Expected one of: ${DATE_COLUMN_CANDIDATES.join(\", \")}.`,\n        },\n        { status: 400 }\n      )\n    }\n\n    const { filters: lineFilters, params: lineParams, earlyEmpty } = await buildLineFilters(\n      columnNames,\n      normalizedLineId\n    )\n\n    if (earlyEmpty) {\n      return NextResponse.json({\n        table: tableName,\n        cutoff: `${baseTsCol} >= CONVERT_TZ(UTC_TIMESTAMP(),'UTC','+09:00') - INTERVAL 36 HOUR`,\n        from: null,\n        to: null,\n        rowCount: 0,\n        columns: columnNames,\n        rows: [],\n      })\n    }\n\n    const whereParts = [...lineFilters]\n    const params = [...lineParams]\n\n    whereParts.push(`\\`${baseTsCol}\\` >= (CONVERT_TZ(UTC_TIMESTAMP(), 'UTC', '+09:00') - INTERVAL 36 HOUR)`)\n\n    if (normalizedFrom) {\n      params.push(`${normalizedFrom} 00:00:00`)\n      whereParts.push(`\\`${baseTsCol}\\` >= ?`)\n    }\n\n    if (normalizedTo) {\n      params.push(`${normalizedTo} 23:59:59`)\n      whereParts.push(`\\`${baseTsCol}\\` <= ?`)\n    }\n\n    const whereClause = whereParts.length ? `WHERE ${whereParts.join(\" AND \")}` : \"\"\n    const orderClause = `ORDER BY \\`${baseTsCol}\\` DESC, \\`id\\` DESC`\n\n    const rows = await runQuery(\n      `\n        SELECT *\n        FROM \\`${tableName}\\`\n        ${whereClause}\n        ${orderClause}\n      `,\n      params\n    )\n\n    return NextResponse.json({\n      table: tableName,\n      cutoff: `${baseTsCol} >= CONVERT_TZ(UTC_TIMESTAMP(),'UTC','+09:00') - INTERVAL 36 HOUR`,\n      from: normalizedFrom || null,\n      to: normalizedTo || null,\n      rowCount: rows.length,\n      columns: columnNames,\n      rows,\n    })\n  } catch (error) {\n    if (error && typeof error === \"object\" && error.code === \"ER_NO_SUCH_TABLE\") {\n      return NextResponse.json({ error: `Table \"${tableName}\" was not found` }, { status: 404 })\n    }\n\n    console.error(\"Failed to load table data\", error)\n    return NextResponse.json({ error: \"Failed to load table data\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}