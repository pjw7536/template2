# =============================================================================
# 모듈: 어시스턴트 설정/입력 파싱 유틸
# 주요 함수: _read_setting, _parse_string_list, _normalize_string_list
# 주요 가정: 설정 값은 문자열/숫자/불리언 형태로 들어올 수 있습니다.
# =============================================================================
from __future__ import annotations

import json
import os
from typing import List, Optional, Sequence

from django.conf import settings


def _read_setting(name: str, fallback: Optional[str] = None) -> Optional[str]:
    """Django settings 또는 환경변수에서 설정 값을 문자열로 읽습니다.

    인자:
        name: 설정 키 이름.
        fallback: 값이 없을 때 사용할 기본값.

    반환:
        문자열 설정 값 또는 None.

    부작용:
        없음. 읽기 전용 조회입니다.
    """

    # -----------------------------------------------------------------------------
    # 1) Django settings 우선 조회
    # -----------------------------------------------------------------------------
    value = getattr(settings, name, None)
    # -----------------------------------------------------------------------------
    # 2) 환경변수 fallback
    # -----------------------------------------------------------------------------
    if value is None:
        value = os.environ.get(name, fallback)
    # -----------------------------------------------------------------------------
    # 3) 문자열로 정규화
    # -----------------------------------------------------------------------------
    if value is None:
        return None
    if isinstance(value, str):
        return value
    return str(value)


def _parse_int(value: Optional[str], default: int) -> int:
    """문자열 값을 양의 정수로 파싱하고 실패 시 기본값을 반환합니다.

    인자:
        value: 원본 문자열 값.
        default: 파싱 실패 시 반환할 기본값.

    반환:
        양의 정수(0 이하이면 기본값으로 치환).

    부작용:
        없음. 순수 파싱입니다.
    """

    # -----------------------------------------------------------------------------
    # 1) None 입력 처리
    # -----------------------------------------------------------------------------
    if value is None:
        return default
    # -----------------------------------------------------------------------------
    # 2) 정수 변환 및 양수 보장
    # -----------------------------------------------------------------------------
    try:
        parsed = int(str(value).strip())
        return parsed if parsed > 0 else default
    except (TypeError, ValueError):
        return default


def _parse_float(value: Optional[str], default: float) -> float:
    """문자열 값을 float로 파싱하고 실패 시 기본값을 반환합니다.

    인자:
        value: 원본 문자열 값.
        default: 파싱 실패 시 반환할 기본값.

    반환:
        float 값 또는 기본값.

    부작용:
        없음. 순수 파싱입니다.
    """

    # -----------------------------------------------------------------------------
    # 1) None 입력 처리
    # -----------------------------------------------------------------------------
    if value is None:
        return default
    # -----------------------------------------------------------------------------
    # 2) float 변환
    # -----------------------------------------------------------------------------
    try:
        return float(str(value).strip())
    except (TypeError, ValueError):
        return default


def _parse_bool(value: Optional[str], default: bool = False) -> bool:
    """문자열 값을 boolean으로 파싱합니다(1/true/yes/on=True).

    인자:
        value: 원본 문자열 값.
        default: 파싱 실패 시 반환할 기본값.

    반환:
        boolean 값.

    부작용:
        없음. 순수 파싱입니다.
    """

    # -----------------------------------------------------------------------------
    # 1) None 입력 처리
    # -----------------------------------------------------------------------------
    if value is None:
        return default
    # -----------------------------------------------------------------------------
    # 2) 문자열 정규화 후 참/거짓 판단
    # -----------------------------------------------------------------------------
    normalized = str(value).strip().lower()
    return normalized in {"1", "true", "yes", "on"}


def _parse_string_list(raw: Optional[str]) -> List[str]:
    """JSON 배열/개행 문자열 등을 문자열 리스트로 정규화합니다.

    인자:
        raw: JSON 문자열 또는 개행/단일 문자열.

    반환:
        공백 제거가 적용된 문자열 리스트.

    부작용:
        없음. 순수 정규화입니다.

    오류:
        JSON 파싱 실패 시 빈 리스트로 처리합니다.
    """

    # -----------------------------------------------------------------------------
    # 1) 입력 유무 확인
    # -----------------------------------------------------------------------------
    if not raw:
        return []

    # -----------------------------------------------------------------------------
    # 2) JSON 배열 시도
    # -----------------------------------------------------------------------------
    try:
        parsed = json.loads(raw)
    except (json.JSONDecodeError, TypeError):
        parsed = None

    # -----------------------------------------------------------------------------
    # 3) 배열 형태 처리
    # -----------------------------------------------------------------------------
    if isinstance(parsed, Sequence) and not isinstance(parsed, (str, bytes)):
        return [str(item).strip() for item in parsed if str(item).strip()]

    # -----------------------------------------------------------------------------
    # 4) 문자열(개행/단일) 처리
    # -----------------------------------------------------------------------------
    if isinstance(raw, str):
        if "\n" in raw:
            return [item.strip() for item in raw.splitlines() if item.strip()]
        return [raw.strip()]

    return []


def _normalize_string_list(raw: Optional[Sequence[str] | str]) -> List[str]:
    """문자열 또는 문자열 리스트를 정규화합니다.

    인자:
        raw: 문자열 또는 문자열 시퀀스.

    반환:
        중복 제거/공백 제거가 적용된 문자열 리스트.

    부작용:
        없음. 순수 정규화입니다.
    """

    # -----------------------------------------------------------------------------
    # 1) 입력 유무 확인
    # -----------------------------------------------------------------------------
    if not raw:
        return []

    # -----------------------------------------------------------------------------
    # 2) 입력 타입 정규화
    # -----------------------------------------------------------------------------
    if isinstance(raw, str):
        values = [raw]
    elif isinstance(raw, Sequence):
        values = list(raw)
    else:
        return []

    # -----------------------------------------------------------------------------
    # 3) 공백 제거 및 중복 제거
    # -----------------------------------------------------------------------------
    normalized: List[str] = []
    for item in values:
        if item is None:
            continue
        cleaned = str(item).strip()
        if cleaned:
            normalized.append(cleaned)
    return list(dict.fromkeys(normalized))
